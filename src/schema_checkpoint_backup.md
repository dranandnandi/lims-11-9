-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.ai_captures (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  session_id uuid,
  step_id uuid,
  capture_type character varying NOT NULL,
  file_path character varying,
  file_size_bytes bigint,
  mime_type character varying,
  capture_metadata jsonb DEFAULT '{}'::jsonb,
  analysis_status character varying DEFAULT 'pending'::character varying,
  analysis_results jsonb DEFAULT '{}'::jsonb,
  confidence_score numeric,
  processed_at timestamp with time zone,
  processing_duration_ms integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_captures_pkey PRIMARY KEY (id),
  CONSTRAINT ai_captures_step_id_fkey FOREIGN KEY (step_id) REFERENCES public.ai_protocol_steps(id),
  CONSTRAINT ai_captures_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.ai_protocol_sessions(id)
);
CREATE TABLE public.ai_issues (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_result_id uuid NOT NULL,
  severity text NOT NULL,
  field text,
  code text,
  message text NOT NULL,
  suggestion text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ai_issues_pkey PRIMARY KEY (id),
  CONSTRAINT ai_issues_workflow_result_id_fkey FOREIGN KEY (workflow_result_id) REFERENCES public.workflow_results(id)
);
CREATE TABLE public.ai_prompts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  test_id uuid,
  analyte_id uuid,
  lab_id uuid,
  ai_processing_type character varying NOT NULL,
  prompt text NOT NULL,
  default boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ai_prompts_pkey PRIMARY KEY (id),
  CONSTRAINT fk_ai_prompts_test_group FOREIGN KEY (test_id) REFERENCES public.test_groups(id),
  CONSTRAINT fk_ai_prompts_analyte FOREIGN KEY (analyte_id) REFERENCES public.analytes(id),
  CONSTRAINT fk_ai_prompts_lab FOREIGN KEY (lab_id) REFERENCES public.labs(id)
);
CREATE TABLE public.ai_protocol_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  protocol_id uuid,
  order_id uuid,
  patient_id uuid,
  test_id uuid,
  status character varying DEFAULT 'started'::character varying,
  current_step_id uuid,
  current_step_order integer DEFAULT 1,
  session_data jsonb DEFAULT '{}'::jsonb,
  results jsonb DEFAULT '{}'::jsonb,
  started_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  duration_seconds integer,
  user_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_protocol_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT ai_protocol_sessions_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT ai_protocol_sessions_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT ai_protocol_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT ai_protocol_sessions_current_step_id_fkey FOREIGN KEY (current_step_id) REFERENCES public.ai_protocol_steps(id),
  CONSTRAINT ai_protocol_sessions_protocol_id_fkey FOREIGN KEY (protocol_id) REFERENCES public.ai_protocols(id)
);
CREATE TABLE public.ai_protocol_steps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  protocol_id uuid,
  step_order integer NOT NULL,
  step_type character varying NOT NULL,
  title character varying NOT NULL,
  description text,
  config jsonb NOT NULL DEFAULT '{}'::jsonb,
  is_required boolean DEFAULT true,
  validation_rules jsonb DEFAULT '{}'::jsonb,
  estimated_duration_seconds integer,
  max_duration_seconds integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_protocol_steps_pkey PRIMARY KEY (id),
  CONSTRAINT ai_protocol_steps_protocol_id_fkey FOREIGN KEY (protocol_id) REFERENCES public.ai_protocols(id)
);
CREATE TABLE public.ai_protocols (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  description text,
  category character varying NOT NULL,
  version text DEFAULT '1.0'::character varying,
  is_active boolean DEFAULT true,
  config jsonb NOT NULL DEFAULT '{}'::jsonb,
  requires_lims_integration boolean DEFAULT false,
  target_table character varying,
  result_mapping jsonb DEFAULT '{}'::jsonb,
  ui_config jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  updated_at timestamp with time zone DEFAULT now(),
  updated_by uuid,
  CONSTRAINT ai_protocols_pkey PRIMARY KEY (id),
  CONSTRAINT ai_protocols_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT ai_protocols_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES auth.users(id)
);
CREATE TABLE public.ai_runs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_result_id uuid NOT NULL,
  kind text NOT NULL,
  model text NOT NULL,
  request jsonb NOT NULL,
  response jsonb,
  ok boolean,
  duration_ms integer,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ai_runs_pkey PRIMARY KEY (id),
  CONSTRAINT ai_runs_workflow_result_id_fkey FOREIGN KEY (workflow_result_id) REFERENCES public.workflow_results(id)
);
CREATE TABLE public.ai_usage_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  lab_id uuid,
  processing_type character varying NOT NULL,
  input_data jsonb,
  confidence numeric,
  tokens_used integer,
  processing_time_ms integer,
  error_message text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ai_usage_logs_pkey PRIMARY KEY (id),
  CONSTRAINT ai_usage_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT ai_usage_logs_lab_id_fkey FOREIGN KEY (lab_id) REFERENCES public.labs(id)
);
CREATE TABLE public.analyte_aliases (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  analyte_id uuid NOT NULL,
  alias text NOT NULL,
  CONSTRAINT analyte_aliases_pkey PRIMARY KEY (id),
  CONSTRAINT analyte_aliases_analyte_id_fkey FOREIGN KEY (analyte_id) REFERENCES public.analytes(id)
);
CREATE TABLE public.analytes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL UNIQUE,
  unit character varying NOT NULL,
  reference_range text NOT NULL,
  low_critical character varying,
  high_critical character varying,
  interpretation_low text,
  interpretation_normal text,
  interpretation_high text,
  category character varying NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  ai_processing_type text DEFAULT 'ocr_report'::text CHECK ((ai_processing_type = ANY (ARRAY['ocr_report'::text, 'vision_card'::text, 'vision_color'::text, 'none'::text])) OR ai_processing_type IS NULL),
  ai_prompt_override text,
  group_ai_mode USER-DEFINED DEFAULT 'individual'::group_ai_mode,
  is_global boolean DEFAULT true,
  to_be_copied boolean DEFAULT false,
  CONSTRAINT analytes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.attachments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid,
  related_table text NOT NULL,
  related_id uuid NOT NULL,
  file_url text NOT NULL,
  file_type text,
  description text,
  uploaded_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  lab_id uuid,
  file_path text,
  original_filename text,
  stored_filename text,
  file_size bigint,
  upload_timestamp timestamp with time zone DEFAULT now(),
  ai_processed boolean DEFAULT false,
  ai_confidence numeric,
  processing_status text CHECK (processing_status = ANY (ARRAY['pending'::text, 'processed'::text, 'failed'::text])),
  ai_processed_at timestamp without time zone,
  ai_processing_type text,
  ai_metadata jsonb,
  tag text,
  CONSTRAINT attachments_pkey PRIMARY KEY (id),
  CONSTRAINT attachments_lab_id_fkey FOREIGN KEY (lab_id) REFERENCES public.labs(id),
  CONSTRAINT attachments_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT attachments_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.users(id)
);
CREATE TABLE public.audit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  table_name character varying NOT NULL,
  record_id uuid NOT NULL,
  action character varying NOT NULL,
  old_values jsonb,
  new_values jsonb,
  user_id uuid,
  user_email character varying,
  timestamp timestamp with time zone DEFAULT now(),
  CONSTRAINT audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT audit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.departments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  code character varying NOT NULL UNIQUE,
  description text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT departments_pkey PRIMARY KEY (id)
);
CREATE TABLE public.invoice_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  invoice_id uuid NOT NULL,
  test_name character varying NOT NULL,
  price numeric NOT NULL CHECK (price >= 0::numeric),
  quantity integer DEFAULT 1 CHECK (quantity > 0),
  total numeric NOT NULL CHECK (total >= 0::numeric),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT invoice_items_pkey PRIMARY KEY (id),
  CONSTRAINT invoice_items_invoice_id_fkey FOREIGN KEY (invoice_id) REFERENCES public.invoices(id)
);
CREATE TABLE public.invoices (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  order_id uuid,
  patient_name character varying NOT NULL,
  subtotal numeric NOT NULL CHECK (subtotal >= 0::numeric),
  discount numeric DEFAULT 0 CHECK (discount >= 0::numeric),
  tax numeric NOT NULL CHECK (tax >= 0::numeric),
  total numeric NOT NULL CHECK (total >= 0::numeric),
  status USER-DEFINED NOT NULL DEFAULT 'Draft'::invoice_status,
  invoice_date date NOT NULL DEFAULT CURRENT_DATE,
  due_date date NOT NULL,
  payment_method character varying,
  payment_date date,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT invoices_pkey PRIMARY KEY (id),
  CONSTRAINT invoices_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT invoices_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.lab_analytes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  lab_id uuid NOT NULL,
  analyte_id uuid NOT NULL,
  is_active boolean DEFAULT true,
  visible boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  lab_specific_reference_range text,
  lab_specific_interpretation_low text,
  lab_specific_interpretation_normal text,
  lab_specific_interpretation_high text,
  CONSTRAINT lab_analytes_pkey PRIMARY KEY (id),
  CONSTRAINT lab_analytes_analyte_id_fkey FOREIGN KEY (analyte_id) REFERENCES public.analytes(id),
  CONSTRAINT lab_analytes_lab_id_fkey FOREIGN KEY (lab_id) REFERENCES public.labs(id)
);
CREATE TABLE public.labs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  code character varying NOT NULL UNIQUE,
  address text,
  city character varying,
  state character varying,
  pincode character varying,
  phone character varying,
  email character varying,
  license_number character varying,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT labs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.ocr_results (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  attachment_id uuid,
  raw_text text NOT NULL,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT ocr_results_pkey PRIMARY KEY (id),
  CONSTRAINT ocr_results_attachment_id_fkey FOREIGN KEY (attachment_id) REFERENCES public.attachments(id)
);
CREATE TABLE public.order_test_groups (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_id uuid NOT NULL,
  test_group_id uuid NOT NULL,
  test_name character varying NOT NULL,
  price numeric NOT NULL CHECK (price >= 0::numeric),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT order_test_groups_pkey PRIMARY KEY (id),
  CONSTRAINT order_test_groups_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT order_test_groups_test_group_id_fkey FOREIGN KEY (test_group_id) REFERENCES public.test_groups(id)
);
CREATE TABLE public.order_tests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_id uuid NOT NULL,
  test_name character varying NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  test_group_id uuid,
  sample_id uuid,
  CONSTRAINT order_tests_pkey PRIMARY KEY (id),
  CONSTRAINT order_tests_order_sample_fk FOREIGN KEY (order_id) REFERENCES public.samples(id),
  CONSTRAINT order_tests_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT order_tests_test_group_id_fkey FOREIGN KEY (test_group_id) REFERENCES public.test_groups(id),
  CONSTRAINT order_tests_order_sample_fk FOREIGN KEY (sample_id) REFERENCES public.samples(id),
  CONSTRAINT order_tests_order_sample_fk FOREIGN KEY (order_id) REFERENCES public.samples(order_id),
  CONSTRAINT order_tests_order_sample_fk FOREIGN KEY (sample_id) REFERENCES public.samples(order_id)
);
CREATE TABLE public.order_workflow_instances (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_id uuid NOT NULL UNIQUE,
  workflow_version_id uuid NOT NULL,
  current_step_id text,
  started_at timestamp with time zone NOT NULL DEFAULT now(),
  completed_at timestamp with time zone,
  CONSTRAINT order_workflow_instances_pkey PRIMARY KEY (id),
  CONSTRAINT order_workflow_instances_workflow_version_id_fkey FOREIGN KEY (workflow_version_id) REFERENCES public.workflow_versions(id),
  CONSTRAINT order_workflow_instances_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.orders (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  patient_name character varying NOT NULL,
  priority USER-DEFINED NOT NULL DEFAULT 'Normal'::priority_type,
  order_date date NOT NULL DEFAULT CURRENT_DATE,
  expected_date date NOT NULL,
  total_amount numeric NOT NULL CHECK (total_amount >= 0::numeric),
  doctor character varying NOT NULL,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  parent_order_id uuid,
  order_type character varying DEFAULT 'initial'::character varying,
  visit_group_id character varying,
  addition_reason text,
  can_add_tests boolean DEFAULT true,
  locked_at timestamp with time zone,
  created_by uuid,
  status_updated_at timestamp with time zone,
  status_updated_by character varying,
  delivered_at timestamp with time zone,
  delivered_by character varying,
  color_code text,
  color_name text,
  qr_code_data text,
  lab_id uuid,
  status USER-DEFINED NOT NULL DEFAULT 'Order Created'::order_status,
  sample_id text UNIQUE,
  sample_collected_at timestamp with time zone,
  sample_collected_by text,
  tube_barcode text,
  workflow_status text,
  CONSTRAINT orders_pkey PRIMARY KEY (id),
  CONSTRAINT orders_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id),
  CONSTRAINT orders_parent_order_id_fkey FOREIGN KEY (parent_order_id) REFERENCES public.orders(id),
  CONSTRAINT orders_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT orders_lab_id_fkey FOREIGN KEY (lab_id) REFERENCES public.labs(id)
);
CREATE TABLE public.package_test_groups (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  package_id uuid NOT NULL,
  test_group_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT package_test_groups_pkey PRIMARY KEY (id),
  CONSTRAINT package_test_groups_package_id_fkey FOREIGN KEY (package_id) REFERENCES public.packages(id),
  CONSTRAINT package_test_groups_test_group_id_fkey FOREIGN KEY (test_group_id) REFERENCES public.test_groups(id)
);
CREATE TABLE public.packages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  description text NOT NULL,
  price numeric NOT NULL CHECK (price >= 0::numeric),
  discount_percentage numeric DEFAULT 0 CHECK (discount_percentage >= 0::numeric AND discount_percentage <= 100::numeric),
  category character varying NOT NULL,
  validity_days integer DEFAULT 30 CHECK (validity_days > 0),
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  lab_id uuid,
  CONSTRAINT packages_pkey PRIMARY KEY (id),
  CONSTRAINT packages_lab_id_fkey FOREIGN KEY (lab_id) REFERENCES public.labs(id)
);
CREATE TABLE public.patient_activity_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid,
  order_id uuid,
  activity_type character varying NOT NULL,
  description text,
  metadata jsonb DEFAULT '{}'::jsonb,
  performed_by uuid,
  performed_at timestamp with time zone DEFAULT now(),
  lab_id uuid,
  CONSTRAINT patient_activity_log_pkey PRIMARY KEY (id),
  CONSTRAINT patient_activity_log_lab_id_fkey FOREIGN KEY (lab_id) REFERENCES public.labs(id),
  CONSTRAINT patient_activity_log_performed_by_fkey FOREIGN KEY (performed_by) REFERENCES public.users(id),
  CONSTRAINT patient_activity_log_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT patient_activity_log_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.patients (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  age integer NOT NULL CHECK (age >= 0 AND age <= 150),
  gender USER-DEFINED NOT NULL,
  phone character varying NOT NULL,
  email character varying,
  address text NOT NULL,
  city character varying NOT NULL,
  state character varying NOT NULL,
  pincode character varying NOT NULL,
  emergency_contact character varying,
  emergency_phone character varying,
  blood_group USER-DEFINED,
  allergies text,
  medical_history text,
  registration_date date NOT NULL DEFAULT CURRENT_DATE,
  last_visit date NOT NULL DEFAULT CURRENT_DATE,
  total_tests integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  external_patient_id character varying,
  display_id character varying,
  referring_doctor character varying,
  CONSTRAINT patients_pkey PRIMARY KEY (id)
);
CREATE TABLE public.payments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  invoice_id uuid NOT NULL,
  amount numeric NOT NULL,
  payment_method text NOT NULL,
  payment_reference text,
  payment_date date DEFAULT CURRENT_DATE,
  received_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payments_pkey PRIMARY KEY (id),
  CONSTRAINT payments_invoice_id_fkey FOREIGN KEY (invoice_id) REFERENCES public.invoices(id),
  CONSTRAINT payments_received_by_fkey FOREIGN KEY (received_by) REFERENCES public.users(id)
);
CREATE TABLE public.quality_control_results (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  test_group_id uuid,
  qc_type text NOT NULL,
  qc_value numeric,
  expected_value numeric,
  tolerance_range numeric,
  pass_fail boolean,
  notes text,
  technician_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT quality_control_results_pkey PRIMARY KEY (id),
  CONSTRAINT quality_control_results_test_group_id_fkey FOREIGN KEY (test_group_id) REFERENCES public.test_groups(id),
  CONSTRAINT quality_control_results_technician_id_fkey FOREIGN KEY (technician_id) REFERENCES public.users(id)
);
CREATE TABLE public.reports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  patient_id uuid NOT NULL,
  result_id uuid,
  generated_date timestamp with time zone DEFAULT now(),
  status character varying DEFAULT 'pending'::character varying,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  doctor character varying NOT NULL DEFAULT ''::character varying,
  order_id uuid UNIQUE,
  pdf_url text,
  pdf_generated_at timestamp with time zone,
  report_status text DEFAULT 'pending'::text,
  report_type text DEFAULT 'Laboratory Report'::text,
  CONSTRAINT reports_pkey PRIMARY KEY (id),
  CONSTRAINT fk_reports_result FOREIGN KEY (result_id) REFERENCES public.results(id),
  CONSTRAINT reports_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT fk_reports_patient FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.result_values (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  result_id uuid NOT NULL,
  analyte_id uuid,
  parameter character varying NOT NULL,
  value character varying NOT NULL,
  unit character varying NOT NULL,
  reference_range text NOT NULL,
  flag character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  order_id uuid,
  analyte_name text,
  units text,
  order_test_id uuid,
  test_group_id uuid,
  lab_id uuid,
  order_test_group_id uuid,
  CONSTRAINT result_values_pkey PRIMARY KEY (id),
  CONSTRAINT result_values_analyte_id_fkey FOREIGN KEY (analyte_id) REFERENCES public.analytes(id),
  CONSTRAINT result_values_result_id_fkey FOREIGN KEY (result_id) REFERENCES public.results(id),
  CONSTRAINT rv_tg_analyte_fkey FOREIGN KEY (analyte_id) REFERENCES public.test_group_analytes(test_group_id),
  CONSTRAINT rv_tg_analyte_fkey FOREIGN KEY (test_group_id) REFERENCES public.test_group_analytes(test_group_id),
  CONSTRAINT rv_tg_analyte_fkey FOREIGN KEY (analyte_id) REFERENCES public.test_group_analytes(analyte_id),
  CONSTRAINT rv_tg_analyte_fkey FOREIGN KEY (test_group_id) REFERENCES public.test_group_analytes(analyte_id),
  CONSTRAINT result_values_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT rv_order_test_id_fkey FOREIGN KEY (order_test_id) REFERENCES public.order_tests(id),
  CONSTRAINT rv_test_group_id_fkey FOREIGN KEY (test_group_id) REFERENCES public.test_groups(id),
  CONSTRAINT rv_lab_id_fkey FOREIGN KEY (lab_id) REFERENCES public.labs(id),
  CONSTRAINT rv_order_test_group_id_fkey FOREIGN KEY (order_test_group_id) REFERENCES public.order_test_groups(id)
);
CREATE TABLE public.result_verification_audit (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  result_id uuid,
  action character varying NOT NULL,
  performed_by uuid,
  performed_at timestamp with time zone DEFAULT now(),
  previous_status character varying,
  new_status character varying,
  comment text,
  metadata jsonb,
  CONSTRAINT result_verification_audit_pkey PRIMARY KEY (id),
  CONSTRAINT result_verification_audit_result_id_fkey FOREIGN KEY (result_id) REFERENCES public.results(id),
  CONSTRAINT result_verification_audit_performed_by_fkey FOREIGN KEY (performed_by) REFERENCES public.users(id)
);
CREATE TABLE public.result_verification_notes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  result_id uuid,
  author_id uuid,
  note text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT result_verification_notes_pkey PRIMARY KEY (id),
  CONSTRAINT result_verification_notes_result_id_fkey FOREIGN KEY (result_id) REFERENCES public.results(id),
  CONSTRAINT result_verification_notes_author_id_fkey FOREIGN KEY (author_id) REFERENCES public.users(id)
);
CREATE TABLE public.results (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_id uuid NOT NULL,
  patient_id uuid NOT NULL,
  patient_name character varying NOT NULL,
  test_name character varying NOT NULL,
  status USER-DEFINED NOT NULL DEFAULT 'Entered'::result_status,
  entered_by character varying NOT NULL,
  entered_date date NOT NULL DEFAULT CURRENT_DATE,
  reviewed_by character varying,
  reviewed_date date,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  extracted_by_ai boolean DEFAULT false,
  ai_confidence numeric,
  manually_verified boolean DEFAULT false,
  ai_extraction_metadata jsonb,
  attachment_id uuid,
  verification_status character varying DEFAULT 'pending_verification'::character varying CHECK (verification_status::text = ANY (ARRAY['pending_verification'::character varying, 'needs_clarification'::character varying, 'verified'::character varying, 'rejected'::character varying]::text[])),
  verified_by uuid,
  verified_at timestamp with time zone,
  review_comment text,
  technician_notes text,
  delta_check_flag boolean DEFAULT false,
  critical_flag boolean DEFAULT false,
  priority_level integer DEFAULT 1 CHECK (priority_level >= 1 AND priority_level <= 5),
  is_locked boolean DEFAULT false,
  locked_reason text,
  locked_at timestamp with time zone,
  locked_by uuid,
  workflow_instance_id uuid,
  technician_id uuid,
  result_date timestamp with time zone DEFAULT now(),
  order_test_group_id uuid,
  test_group_id uuid,
  lab_id uuid,
  order_test_id uuid,
  CONSTRAINT results_pkey PRIMARY KEY (id),
  CONSTRAINT results_attachment_id_fkey FOREIGN KEY (attachment_id) REFERENCES public.attachments(id),
  CONSTRAINT results_locked_by_fkey FOREIGN KEY (locked_by) REFERENCES public.users(id),
  CONSTRAINT results_technician_id_fkey FOREIGN KEY (technician_id) REFERENCES public.users(id),
  CONSTRAINT results_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.users(id),
  CONSTRAINT results_order_test_id_fkey FOREIGN KEY (order_test_id) REFERENCES public.order_tests(id),
  CONSTRAINT results_lab_id_fkey FOREIGN KEY (lab_id) REFERENCES public.labs(id),
  CONSTRAINT results_test_group_id_fkey FOREIGN KEY (test_group_id) REFERENCES public.test_groups(id),
  CONSTRAINT results_order_test_group_id_fkey FOREIGN KEY (order_test_group_id) REFERENCES public.order_test_groups(id),
  CONSTRAINT fk_results_workflow_instance FOREIGN KEY (workflow_instance_id) REFERENCES public.order_workflow_instances(id),
  CONSTRAINT results_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT results_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES public.patients(id)
);
CREATE TABLE public.samples (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_id uuid NOT NULL,
  sample_type text,
  barcode text UNIQUE,
  container_type text,
  specimen_site text,
  lab_id uuid,
  status USER-DEFINED NOT NULL DEFAULT 'created'::sample_status,
  collected_at timestamp with time zone,
  received_at timestamp with time zone,
  processed_at timestamp with time zone,
  rejected_at timestamp with time zone,
  rejection_reason text,
  collected_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT samples_pkey PRIMARY KEY (id),
  CONSTRAINT samples_collected_by_fkey FOREIGN KEY (collected_by) REFERENCES public.users(id),
  CONSTRAINT samples_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT samples_lab_id_fkey FOREIGN KEY (lab_id) REFERENCES public.labs(id)
);
CREATE TABLE public.task_runs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_result_id uuid NOT NULL,
  task_id uuid NOT NULL,
  status text NOT NULL,
  request jsonb NOT NULL,
  response jsonb,
  duration_ms integer,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT task_runs_pkey PRIMARY KEY (id),
  CONSTRAINT task_runs_workflow_result_id_fkey FOREIGN KEY (workflow_result_id) REFERENCES public.workflow_results(id),
  CONSTRAINT task_runs_task_id_fkey FOREIGN KEY (task_id) REFERENCES public.workflow_tasks(id)
);
CREATE TABLE public.test_group_analytes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  test_group_id uuid NOT NULL,
  analyte_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT test_group_analytes_pkey PRIMARY KEY (id),
  CONSTRAINT test_group_analytes_analyte_id_fkey FOREIGN KEY (analyte_id) REFERENCES public.analytes(id),
  CONSTRAINT test_group_analytes_test_group_id_fkey FOREIGN KEY (test_group_id) REFERENCES public.test_groups(id)
);
CREATE TABLE public.test_groups (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  code character varying NOT NULL UNIQUE,
  category character varying NOT NULL,
  clinical_purpose text NOT NULL,
  price numeric NOT NULL CHECK (price >= 0::numeric),
  turnaround_time character varying NOT NULL,
  sample_type USER-DEFINED NOT NULL,
  requires_fasting boolean DEFAULT false,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  default_ai_processing_type character varying DEFAULT 'ocr_report'::character varying,
  group_level_prompt text,
  lab_id uuid,
  to_be_copied boolean DEFAULT false,
  description text,
  CONSTRAINT test_groups_pkey PRIMARY KEY (id),
  CONSTRAINT test_groups_lab_id_fkey FOREIGN KEY (lab_id) REFERENCES public.labs(id)
);
CREATE TABLE public.test_workflow_map (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  lab_id uuid NOT NULL,
  test_code text NOT NULL,
  workflow_version_id uuid NOT NULL,
  is_default boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  test_group_id uuid,
  analyte_id uuid,
  priority integer DEFAULT 100,
  conditions jsonb,
  CONSTRAINT test_workflow_map_pkey PRIMARY KEY (id),
  CONSTRAINT test_workflow_map_workflow_version_id_fkey FOREIGN KEY (workflow_version_id) REFERENCES public.workflow_versions(id),
  CONSTRAINT test_workflow_map_test_group_id_fkey FOREIGN KEY (test_group_id) REFERENCES public.test_groups(id),
  CONSTRAINT test_workflow_map_analyte_id_fkey FOREIGN KEY (analyte_id) REFERENCES public.analytes(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  email character varying NOT NULL UNIQUE,
  role USER-DEFINED NOT NULL,
  department character varying,
  status USER-DEFINED NOT NULL DEFAULT 'Active'::user_status,
  phone character varying,
  join_date date NOT NULL DEFAULT CURRENT_DATE,
  last_login timestamp with time zone,
  permissions ARRAY,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  department_id uuid,
  lab_id uuid,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT users_department_id_fkey FOREIGN KEY (department_id) REFERENCES public.departments(id),
  CONSTRAINT users_lab_id_fkey FOREIGN KEY (lab_id) REFERENCES public.labs(id)
);
CREATE TABLE public.workflow_ai_configs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_version_id uuid NOT NULL,
  test_group_id uuid,
  analyte_id uuid,
  model_provider text NOT NULL DEFAULT 'openai'::text,
  model_name text NOT NULL DEFAULT 'gpt-4o-mini'::text,
  temperature numeric NOT NULL DEFAULT 0.0,
  parser_prompt text NOT NULL,
  validator_prompt text NOT NULL,
  analyte_map jsonb NOT NULL DEFAULT '{}'::jsonb,
  unit_map jsonb NOT NULL DEFAULT '{}'::jsonb,
  required_fields jsonb NOT NULL DEFAULT '[]'::jsonb,
  numeric_rules jsonb NOT NULL DEFAULT '{}'::jsonb,
  enum_rules jsonb NOT NULL DEFAULT '{}'::jsonb,
  flags_rules jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT workflow_ai_configs_pkey PRIMARY KEY (id),
  CONSTRAINT workflow_ai_configs_analyte_id_fkey FOREIGN KEY (analyte_id) REFERENCES public.analytes(id),
  CONSTRAINT workflow_ai_configs_test_group_id_fkey FOREIGN KEY (test_group_id) REFERENCES public.test_groups(id),
  CONSTRAINT workflow_ai_configs_workflow_version_id_fkey FOREIGN KEY (workflow_version_id) REFERENCES public.workflow_versions(id)
);
CREATE TABLE public.workflow_results (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_instance_id uuid NOT NULL,
  step_id text NOT NULL,
  order_id uuid,
  patient_id uuid,
  lab_id uuid,
  test_group_id uuid,
  test_name text,
  test_code text,
  review_status text,
  sample_id text,
  qc_summary text,
  payload jsonb NOT NULL,
  extracted jsonb,
  status text NOT NULL DEFAULT 'received'::text,
  created_by uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  committed_at timestamp with time zone,
  error text,
  CONSTRAINT workflow_results_pkey PRIMARY KEY (id)
);
CREATE TABLE public.workflow_step_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  instance_id uuid NOT NULL,
  step_id text NOT NULL,
  event_type text NOT NULL,
  payload jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT workflow_step_events_pkey PRIMARY KEY (id),
  CONSTRAINT workflow_step_events_instance_id_fkey FOREIGN KEY (instance_id) REFERENCES public.order_workflow_instances(id)
);
CREATE TABLE public.workflow_tasks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_version_id uuid NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['vision_color'::text, 'ocr'::text, 'text_extract'::text, 'cell_count'::text, 'custom_webhook'::text])),
  model_name text,
  tool_url text,
  input_selector jsonb NOT NULL DEFAULT '{}'::jsonb,
  params jsonb NOT NULL DEFAULT '{}'::jsonb,
  output_map jsonb NOT NULL DEFAULT '{}'::jsonb,
  run_order integer NOT NULL DEFAULT 10,
  enabled boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT workflow_tasks_pkey PRIMARY KEY (id),
  CONSTRAINT workflow_tasks_workflow_version_id_fkey FOREIGN KEY (workflow_version_id) REFERENCES public.workflow_versions(id)
);
CREATE TABLE public.workflow_versions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_id uuid NOT NULL,
  version integer NOT NULL,
  definition jsonb NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  active boolean,
  CONSTRAINT workflow_versions_pkey PRIMARY KEY (id),
  CONSTRAINT workflow_versions_workflow_id_fkey FOREIGN KEY (workflow_id) REFERENCES public.workflows(id)
);
CREATE TABLE public.workflows (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  scope text NOT NULL DEFAULT 'lab'::text,
  lab_id uuid,
  active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT workflows_pkey PRIMARY KEY (id),
  CONSTRAINT workflows_lab_id_fkey FOREIGN KEY (lab_id) REFERENCES public.labs(id)
);